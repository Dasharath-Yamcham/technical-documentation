# 010. Labsquire Deployment Documentation (Dev, Stage, Prod)

This document outlines the professional deployment workflow and environment setup for the Labsquire application.

Labsquire consists of:
- **Frontends**: Vue.js, React.js
- **Backends**: Node.js, Next.js (API), Express, Hono
- **Databases**: MongoDB (Atlas), PostgreSQL (AWS RDS)
- **Hosting/Deployments**:
  - Frontend → Vercel (Automated deployments)
  - Backend → AWS EC2 (GitHub Actions CI/CD)
  - Databases → MongoDB Atlas + AWS RDS

## 1. Environments Overview

Labsquire uses three standard environments:

### 1.1 Development (DEV)

- **Purpose**: Internal development, rapid iteration, testing features.
- **Characteristics**:
  - Code pushed to `dev` branch triggers deployments.
  - Uses DEV database instances.
  - Backend deployed to DEV EC2 instance.
  - Frequent deployments.

### 1.2 Staging (STAGE)

- **Purpose**: Final QA, testing before production.
- **Characteristics**:
  - Code pushed to `stage` branch triggers deployments.
  - Uses Stage database instances.
  - Backend deployed to STAGE EC2 instance.
  - Mirrors production as closely as possible.

### 1.3 Production (PROD)

- **Purpose**: Live end-user environment.
- **Characteristics**:
  - Code pushed to `main` or `production` branch triggers deployment.
  - Uses Production databases.
  - Backend deployed to PROD EC2 instance.
  - Stable and secure.

## 2. Frontend Deployment (Vue.js & Next.js) using Vercel

### 2.1 Branch Mapping

| Environment | Git Branch | Deployment Target | Notes                          |
|-------------|------------|-------------------|--------------------------------|
| DEV         | `dev`      | Vercel DEV        | Automatic preview deployments  |
| STAGE       | `stage`    | Vercel STAGE      | Requires approval if configured|
| PROD        | `main`     | Vercel Production | Auto-deploy to main domain     |

### 2.2 Environment Variables in Vercel

Each project in Vercel has three environment sections:
- Development
- Preview
- Production

**Variables required:**
- `API_URL`
- `MONGO_URI`
- `POSTGRES_URI`
- `NEXT_PUBLIC_APP_ENV`
- `JWT_SECRET`

Ensure proper values per environment.

## 3. Backend Deployment using AWS EC2 + GitHub Actions

### 3.1 Server Structure

You will maintain three EC2 instances:
- `labsquire-dev-api-server`
- `labsquire-stage-api-server`
- `labsquire-prod-api-server`

Each EC2 instance runs:
- Node.js runtime
- PM2 process manager
- Nginx reverse proxy (optional but recommended)

### 3.2 GitHub Workflow Setup

Example `.github/workflows/deploy.yml`:

```yaml
on:
  push:
    branches:
      - dev
      - stage
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set Environment Server
        run: |
          if [[ "${GITHUB_REF##*/}" == "dev" ]]; then
            echo "SERVER=DEV" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF##*/}" == "stage" ]]; then
            echo "SERVER=STAGE" >> $GITHUB_ENV
          else
            echo "SERVER=PROD" >> $GITHUB_ENV
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets[format('API_${{ env.SERVER }}_HOST')] }}
          username: ubuntu
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            cd /var/www/labsquire-api
            git pull
            npm install
            pm2 restart all
```

## 4. Database Management

### 4.1 MongoDB Atlas Setup

Create three clusters:
- `labsquire-dev`
- `labsquire-stage`
- `labsquire-prod`

Connection strings stored in Vercel & EC2 environments.

### 4.2 PostgreSQL (RDS)

Configure three RDS instances or databases within one instance:
- `labsquire_dev`
- `labsquire_stage`
- `labsquire_prod`

**Security groups:**
- Allow access only from EC2 instances.

## 5. Environment Architecture Diagram

```
 ┌─────────────────────────┐
 │ GitHub Repo             │
 └────────────┬────────────┘
              │
 ┌──────────┴──────────┐
 │ Branch Workflows    │
 │ dev / stage / main  │
 └──────────┬──────────┘
              │
 ┌──────────────┼──────────────┐
 │              │              │
 DEV Deploy  STAGE Deploy  PROD Deploy
 │              │              │
 Vercel + EC2 Vercel + EC2 Vercel + EC2
 │              │              │
 DEV DB (Atlas/RDS) STAGE DB PROD DB
```

## 6. Release Process

### 6.1 Development Phase

- Developer pushes code to `dev` branch.
- Vercel deploys frontend DEV preview.
- GitHub Actions deploys backend to DEV EC2.
- Testing performed.

### 6.2 Staging Phase

- Once DEV verified → create PR to `stage`.
- Deployment to STAGE.
- QA testing, UAT.
- Approval.

### 6.3 Production Phase

- Merge `stage` → `main`.
- Production deployment begins.
- Vercel deploys production build.
- GitHub deploys backend to PROD server.
- Final smoke testing.

## 7. Monitoring & Logging

### Backend

- PM2 logs
- CloudWatch Logs (optional)
- Nginx logs

### Frontend

- Vercel Analytics

### Database

- MongoDB Atlas Dashboard
- RDS Performance Insights

## 8. Backup & Recovery Strategy

### MongoDB Atlas

- Automated daily backups
- Point-in-time recovery

### RDS

- Automated backups (7–30 days retention)
- Snapshot before major deploys

## 9. Security Best Practices

- Use `.env` files—never commit secrets.
- Use GitHub Secrets for CI/CD variables.
- Restrict server SSH with IP whitelisting.
- Use HTTPS everywhere (Nginx + Certbot).
- Rotate database passwords periodically.

## 10. Summary

This documentation defines the professional deployment workflow for Labsquire across the DEV, STAGE, and PROD environments. It ensures clean branching, stable environment isolation, automated CI/CD pipelines, secure database usage, and production-grade infrastructure.

If you need:
- Architecture diagrams (visual)
- CI/CD YAML examples for each environment
- Nginx configs or PM2 ecosystem files
- Environment variable templates

I can add them next.