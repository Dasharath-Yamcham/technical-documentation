# 009. GitHub CI/CD Workflow Documentation

## 1. Overview

This document describes the CI/CD workflow implemented across three environment branches: DEV, STAGE, and PROD. Each branch has a dedicated purpose and follows a structured pipeline for code validation and deployment.

### Environment Branches

| Environment Branch | Purpose                                                                 |
|--------------------|-------------------------------------------------------------------------|
| DEV (`dev`)        | For development testing, CI validation, and automatic deployment to the DEV server |
| STAGE (`stage`)    | For pre-production testing, CI checks, and automatic deployment to the STAGE server |
| PROD (`prod`)      | For stable production deployment with controlled rolling reload         |

### Workflow Triggers

Workflows run on:

- Push events
- Pull Requests
- Manual dispatch (`workflow_dispatch`)

## 2. Pipeline Structure

All branches follow a standard 4-stage pipeline:

1. Trigger & Checkout
2. CI (Code Quality Checks) — DEV & STAGE only
3. CD (Deployment to Server)
4. Application Reload

## 3. Stage 1 — Trigger & Checkout

The workflow is initiated when:

- A developer pushes code
- A pull request is opened
- A manual trigger is executed

**Actions performed:**

- Clone repository code
- Set up Node.js environment
- Configure runner and SSH if needed

## 4. Stage 2 — CI (DEV & STAGE Only)

This stage ensures code quality and project stability.

### 4.1 Install Dependencies

```bash
npm install
```

### 4.2 Lint Check

Ensures consistent formatting and clean code.

```bash
npm run lint
```

### 4.3 TypeScript Type Check

Verifies type safety.

```bash
npm run type-check
```

### 4.4 Security Audit

Scans for high-severity vulnerabilities.

```bash
npm audit --audit-level=high
```

**Note:** CI failures generate warnings but do not block deployments.

## 5. Stage 3 — Continuous Deployment (CD)

### 5.1 DEV Deployment (dev)

**Steps executed:**

- Backup necessary data directories
- Checkout latest code
- Restore backups
- Apply `.env.dev`
- Install dependencies
- Start the application using PM2
- Validate running PM2 processes

### 5.2 STAGE Deployment (stage)

Same as DEV except:

- Uses `.env.stage` configuration

**Purpose:**

- To mirror production behavior for testing prior to release.

### 5.3 PROD Deployment (prod)

Executed through SSH-based deployment.

**Workflow steps:**

- Load SSH private key
- Connect to production server
- Pull the latest prod branch
- Install project dependencies
- Perform zero-downtime PM2 reload, e.g.:

```bash
pm2 reload 0
pm2 reload 1
...
pm2 reload 15
```

- Remove temporary SSH files after deployment

## 6. Stage 4 — Application Reload

### DEV & STAGE Reload

```bash
pm2 startOrReload ecosystem.config.js
```

### PROD Reload

- Reload is done sequentially, ensuring high availability and zero downtime.

## 7. Pipeline Flow Diagram (Text Representation)

```
Developer Push / PR
 │
 ▼
┌─────────────────────────────┐
│ Stage 1: Trigger & Checkout │
└─────────────────────────────┘
 │
 ▼
┌─────────────────────────────┐
│ Stage 2: CI (DEV & STAGE)   │
│ • Lint                      │
│ • Type-check               │
│ • Security scan            │
└─────────────────────────────┘
 │
 ▼
┌─────────────────────────────┐
│ Stage 3: Deployment         │
│ • DEV → Auto deploy         │
│ • STAGE → Auto deploy       │
│ • PROD → SSH deploy         │
└─────────────────────────────┘
 │
 ▼
┌─────────────────────────────┐
│ Stage 4: PM2 Reload         │
└─────────────────────────────┘
 │
 ▼
 Environment Live
```

## 8. Summary

### DEV (`dev`)

- Runs CI
- Automatically deploys

### STAGE (`stage`)

- Runs CI
- Automatically deploys

### PROD (`prod`)

- No CI
- SSH deployment
- Sequential PM2 reload for stability.