# 004. Doctor Portal – Technical Design Document

**Version:** 1.0  
**Owner:** Sai Durga Masabattula  
**Last Updated:** 2025-12-11  

---

## 1. Overview

The **Doctor Portal** is a web & mobile application that allows doctors and clinic staff to:

- View and manage their **orders** (lab tests) in real time.
- Create new orders for patients.
- View and download **reports**.
- Manage **doctor-specific pricing**, packages, and favorite tests.
- Track and redeem **incentives** (based on the B2B/Yoda pricing model).
- Manage their **profile, locations, and front-desk URLs**.

The portal is designed to be used on both desktop, tablet and mobile devices in a clinical setting, with support for multiple clinics, doctors, and front-desk staff under a single partner account.

---

## 2. Goals & Non-Goals

### 2.1 Goals

1. Provide a **self-service portal** for doctors/clinics to manage lab orders.
2. Enable **transparent incentives** based on the difference between Doctor Price (DP) and Yoda B2B Price (YP).
3. Support **multi-location** clinics and multiple doctors under the same clinic.
4. Offer a **simple, single-screen** order creation experience for front-desk users.
5. Integrate with:
   - LIS / Lab systems for status updates and reports.
   - Payment gateway (e.g., Razorpay).
   - Notification channels (email/SMS/WhatsApp).

### 2.2 Non-Goals

- Building a complete LIS replacement UI (lab staff UI is out of scope).
- Handling deep analytics & dashboards (basic reporting only).
- Implementing complex insurance/TPA workflows in the first phase.

---

## 3. High-Level Architecture

### 3.1 Logical Components

- **Doctor Portal Web App**
  - SPA or SSR-based app (React/Next.js or similar).
  - Interfaces for doctors and front-desk staff.
- **API Gateway / Backend API**
  - Authentication & authorization.
  - Aggregates calls to domain services.
- **Domain Services**
  - **Doctor Service** – profile, locations, front-desk URL, onboarding.
  - **Order Service** – order creation, status, reports, comments.
  - **Pricing Service** – test catalog, doctor-specific pricing, custom packages, favorites.
  - **Incentive Service** – track cumulative incentives and redemptions.
  - **Payment Service** – integrates with Razorpay and incentive balance logic.
- **Persistence Layer (PostgreSQL)**
  - Doctors, locations, users, orders, tests, pricing, incentives, payments.
- **File Storage (S3 or equivalent)**
  - Upload & store reports and prescription images.
- **External Integrations**
  - LIS / Lab APIs.
  - Payment gateway.
  - Notification service (email/SMS/WhatsApp).

### 3.2 High-Level Diagram (Textual)

```text
[Doctor / FrontDesk User]
          |
     (Browser)
          |
   [Doctor Portal Web App]
          |
   [Backend API Gateway]
   /      |         \
[Doctor] [Order]  [Pricing]  [Incentive] [Payment]
    \       |         |         |          /
      [PostgreSQL – Shared Schema]
             |
           [LIS]
             |
         [Reports Store (S3)]
```

---

## 4. User Roles & Permissions

- **Doctor**
  - View own orders and reports.
  - Manage own pricing (if allowed).
  - View incentives, redeem incentives.
  - Configure favorite tests and custom packages.
- **FrontDesk Staff**
  - Create orders for patients.
  - View orders for assigned doctor/clinic.
  - Download/print reports.
- **Clinic Admin**
  - Manage doctors and front-desk users.
  - Configure locations and front-desk URLs.
  - View clinic-level reports and incentives.
- **System Admin (Internal)**
  - Full access for support and configuration.

RBAC can be implemented using a **role-based claim** inside JWT access tokens and enforced at API level.

---

## 5. Data Model (PostgreSQL)

> Note: field names and types are indicative. Actual schema may vary.

### 5.1 Core Tables

#### `doctor`

- `id` (PK, UUID)
- `partner_code` (string, unique per doctor/clinic)
- `full_name` (string)
- `email` (string, unique, nullable)
- `phone` (string, unique)
- `speciality` (string, nullable)
- `status` (enum: ACTIVE, INACTIVE)
- `created_at`, `updated_at`

#### `clinic_location`

- `id` (PK, UUID)
- `doctor_id` or `clinic_id` (FK – depending on final model)
- `name` (e.g. “Main Clinic”, “Branch 2”)
- `address_line1`, `address_line2`
- `city`, `state`, `pincode`
- `latitude`, `longitude` (optional)
- `is_default` (boolean)
- `created_at`, `updated_at`

#### `user_account`

- `id` (PK, UUID)
- `doctor_id` or `clinic_id` (FK, nullable)
- `role` (enum: DOCTOR, FRONT_DESK, CLINIC_ADMIN, SYS_ADMIN)
- `email` (string, unique)
- `phone` (string, unique)
- `password_hash` (string; or external auth id)
- `status` (enum: ACTIVE, INVITED, DISABLED)
- `created_at`, `updated_at`

#### `patient`

- `id` (PK, UUID)
- `full_name`
- `phone`
- `gender` (enum: MALE, FEMALE, OTHER, UNKNOWN)
- `age` or `dob`
- `created_at`, `updated_at`

#### `order`

- `id` (PK, UUID)
- `order_number` (string, unique, human-readable)
- `doctor_id` (FK)
- `location_id` (FK clinic_location)
- `patient_id` (FK)
- `channel` (enum: DOCTOR_PORTAL, FRONTDESK_URL, CUSTOMER_APP, MANUAL)
- `status` (enum: PENDING, IN_PROGRESS, COMPLETED, CANCELLED)
- `visit_type` (enum: HOME_VISIT, LAB, CLINIC_PICKUP)
- `home_locality` (nullable; for home visits)
- `assigned_phlebo_id` (nullable; FK to phlebotomist entity)
- `created_by_user_id` (FK user_account)
- `created_at`, `updated_at`

#### `order_item`

- `id` (PK, UUID)
- `order_id` (FK)
- `test_id` (FK test_catalog)
- `test_name_snapshot` (string) – snapshot for historical correctness
- `yoda_price_snapshot` (decimal)
- `doctor_price_snapshot` (decimal)
- `quantity` (int)
- `status` (enum: PENDING, IN_PROGRESS, COMPLETED, CANCELLED)

#### `test_catalog`

- `id` (PK, UUID)
- `code` (string, unique – test_id used in Excel mapping)
- `name` (string)
- `default_yoda_price` (decimal)
- `category` (string)
- `status` (enum: ACTIVE, INACTIVE)

#### `doctor_test_pricing`

- `id` (PK, UUID)
- `doctor_id` (FK)
- `test_id` (FK test_catalog)
- `doctor_price` (decimal)
- `is_favorite` (boolean)
- `is_custom_package_item` (boolean)
- `created_at`, `updated_at`

#### `doctor_incentive`

- `id` (PK, UUID)
- `doctor_id` (FK)
- `order_id` (FK)
- `order_item_id` (FK)
- `amount` (decimal) – typically (DP - YP) * qty
- `status` (enum: EARNED, REDEEMED, ADJUSTED)
- `created_at`, `updated_at`

#### `incentive_wallet`

- `id` (PK, UUID)
- `doctor_id` (FK)
- `current_balance` (decimal)
- `lifetime_earned` (decimal)
- `lifetime_redeemed` (decimal)
- `updated_at`

#### `payment_transaction`

- `id` (PK, UUID)
- `order_id` (FK)
- `gateway` (enum: RAZORPAY, INCENTIVE_WALLET, MIXED)
- `external_payment_id` (string, nullable)
- `amount` (decimal)
- `currency` (string)
- `status` (enum: CREATED, SUCCESS, FAILED, REFUNDED)
- `created_at`, `updated_at`

#### `report_file`

- `id` (PK, UUID)
- `order_id` (FK)
- `storage_key` (string – S3 key)
- `file_name` (string)
- `mime_type` (string)
- `created_at`

---

## 6. Key Flows

### 6.1 Authentication Flow

1. Doctor or front-desk user visits **Doctor Portal URL**.
2. Enters email/phone + password (or OTP, depending on strategy).
3. Backend verifies credentials and issues:
   - **Access token** (short-lived JWT).
   - **Refresh token** (longer-lived, HTTP-only cookie or secure storage).
4. For each protected API call, Access token is validated and roles/permissions are checked.

### 6.2 Order Creation (Doctor Portal)

1. User chooses **Create Order** from portal.
2. Single screen captures:
   - Patient: name, phone, gender, age.
   - Tests: search-by-name, category, favorites; support select/deselect.
   - Visit type: home visit / lab / clinic pickup.
   - Payment intent: pay now or pay later (depending on business rules).
3. Backend:
   - Creates/updates `patient` record.
   - Creates `order` and `order_item` rows.
   - Computes `yoda_price_snapshot`, `doctor_price_snapshot` and tentative incentive per item.
4. User is redirected to **payment flow** if required (Razorpay/incentive wallet).
5. After payment success, order is:
   - Pushed to **LIS** for processing.
   - Visible in doctor portal and front-desk views.

### 6.3 Viewing Orders & Reports

1. User opens **Orders** page.
2. Frontend filters and paginates orders by:
   - Date range, status (pending/in-progress/completed), patient phone/name.
3. User can click an order to open **order details**:
   - Patient info, tests, prices, status timeline, comments.
4. When LIS uploads results:
   - `report_file` entry is created with S3 key.
   - Doctor Portal shows **View/Download/Print Report** buttons.

### 6.4 Incentive Calculation & Redemption

1. After an order is **completed** and paid:
   - For each `order_item`, incentive is calculated: `(DP - YP) * qty`.
   - `doctor_incentive` rows are created with status `EARNED`.
   - `incentive_wallet.current_balance` is updated.
2. Doctor can view:
   - Current balance, lifetime earned and redeemed.
   - Incentive statement per order.
3. For redemption:
   - Doctor requests payout or uses incentives as **payment method** for future orders.
   - Incentive Service adjusts wallet and logs a `payment_transaction` with gateway `INCENTIVE_WALLET`.

---

## 7. Doctor-Specific Pricing & Packages

### 7.1 Pricing

- Admin provides a base **test catalog** with Yoda B2B prices.
- For each doctor:
  - The team can upload an **Excel sheet** with doctor-specific prices mapped by `test_id`/code.
  - The system imports into `doctor_test_pricing`.
- Portal:
  - Shows tests with **Doctor Price** as the main visible amount.
  - Incentive is derived using stored Yoda price vs doctor price per item.

### 7.2 Favorite Tests & Custom Packages

- Doctor can mark tests as **favorites**:
  - `doctor_test_pricing.is_favorite = true`.
- Doctor can define **custom packages**:
  - Either via a package table (not explicitly modeled here) or by grouping tests.
  - Frontend exposes a **“Favorite Packages”** section for quick ordering.

---

## 8. Integrations

### 8.1 LIS / Lab System

- Orders are pushed to LIS with:
  - Order ID, patient info, ordered tests, doctor info, location.
- LIS returns:
  - Status updates (e.g., sample collected, in lab, completed).
  - Final reports (PDF/HL7 data) which are then stored in S3 and linked in `report_file`.

### 8.2 Payment Gateway (Razorpay)

- When payment method is **Razorpay**:
  - Backend calls Razorpay APIs to create an order.
  - Doctor Portal uses Razorpay checkout in browser.
  - Webhook from Razorpay updates `payment_transaction` and `order` status.

### 8.3 Notifications

- When order is created / completed:
  - Notify patient via SMS/WhatsApp with order details and report link.
  - Notify doctor/clinic through configured channels (e.g., “Customer Delight” WhatsApp group).

---

## 9. Security, Compliance & Auditing

- **Transport Security:** All endpoints served over HTTPS.
- **Data Protection:** PII (patient data) stored encrypted at rest (where required by regulation).
- **Access Control:** RBAC enforced on all APIs based on JWT claims.
- **Audit Logging:** Track sensitive actions:
  - Price changes.
  - Incentive adjustments.
  - Manual order edits/cancellations.
- **Compliance:** Design should be adaptable to region-specific healthcare/privacy regulations (e.g., HIPAA-like controls):

  - Limited access to PHI.
  - Session timeouts and inactivity lock.
  - Secure file access for reports (pre-signed URLs with TTL).

---

## 10. Observability & Operations

- **Logging:**
  - Structured logs (JSON) with correlation IDs per request.
- **Metrics:**
  - Number of orders created per day, per doctor/clinic.
  - Payment success/failure rates.
  - LIS turnaround time.
  - Incentive payout volume.
- **Tracing:**
  - Distributed tracing across API Gateway and domain services.
- **Alerts:**
  - High error rates on order creation or payment.
  - LIS integration failures.
  - Delayed report uploads.

---

## 11. Configuration & Environments

- Environments:
  - `dev`, `qa`, `staging`, `prod`.
- Environment-specific configuration:
  - DB connection strings.
  - Payment gateway keys.
  - LIS endpoints.
  - Storage bucket names.
  - JWT secrets and token lifetimes.
- Use centralized secrets management (e.g., Vault/SSM/KeyVault) instead of committing secrets to code.

---

## 12. Open Questions / TBD

- Final decision on **onboarding model**:
  - Per doctor vs per location vs per clinic.
- Limits & quotas:
  - Max number of locations per doctor.
  - Max number of front-desk users per clinic.
- In-app support:
  - Do we need an in-portal chat widget, or is WhatsApp support sufficient?
- Advanced analytics:
  - Do we need dashboards for revenue, test mix, and patient demographics in the first release?

---

## 13. Future Enhancements

- **OCR-based order creation** from uploaded prescription images.
- **Recommendation engine** for tests/packages based on doctor behavior and patient profile.
- **Embedded teleconsultation links** if needed.
- **Patient-facing portal/app** tightly integrated with Doctor Portal orders.

---

